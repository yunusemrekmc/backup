#define _POSIX_C_SOURCE 200809L

#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>

#include "fs.h"
#include "status.h"

#define BUF_LIMIT 1024
#ifndef BUF_WANT_SIZE
#define BUF_WANT_SIZE 65536
#endif

status_t preparecp(const struct file* f, const char* dst, int follow);

status_t preparecp(const struct file* f, const char* dst, int follow)
{
	char* buf = NULL;
	size_t buf_size = BUF_WANT_SIZE;
	while (!buf) {
		/* Don't even bother if we can't allocate 1KiB of memory */
		if (buf_size < BUF_LIMIT)
			return STATUS_E(ST_ERR_MALLOC, "Creating a buffer for copying", NULL);
		buf = malloc(buf_size);
		buf_size = buf_size << 1;
	}

	DIR* d;
	stream_subdir(-1, dst, follow, &d);

	return STATUS(ST_OK, 0, "Opening files for read", NULL);
}
